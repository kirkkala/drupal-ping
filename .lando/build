#!/bin/bash

set -xeuo pipefail
export PATH=/bin:/sbin:/usr/bin:/usr/sbin:/usr/local/bin

# d7
cd /app/test/

set +e
rm -rf drupal
chmod -R 777 drupal
rm -rf drupal
set -e

# NB! When Composer breaks:
# https://www.drupal.org/project/drupal/issues/3255749
composer create-project drupal-composer/drupal-project:7.x-dev -n drupal

# Fix D7+C2 bug
set +e
cp -rv drupal/web/sites/sites/* drupal/web/sites/
rm -rf drupal/web/sites/sites
set -e

ln -s ../../_ping.custom.php drupal/web/
cd /app/test/drupal
composer require --dev drush/drush:^8

chmod 755 /app/test/drupal/web/sites/default
rm -f /app/test/drupal/web/sites/default/settings.php
ln -s /app/test/settings.php /app/test/drupal/web/sites/default/settings.php
